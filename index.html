<!DOCTYPE html>
<html>
  <head>
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-physics-system@1.4.0/dist/aframe-physics-system.min.js"></script>
    <script src="https://unpkg.com/super-hands/dist/super-hands.min.js"></script>
    <script src="https://cdn.rawgit.com/donmccurdy/aframe-physics-system/v3.1.2/dist/aframe-physics-system.min.js"></script>
    <script src="https://unpkg.com/aframe-event-set-component@^4.1.1/dist/aframe-event-set-component.min.js"></script>
    <script src="https://unpkg.com/aframe-physics-extras/dist/aframe-physics-extras.min.js"></script>
    <script src="https://rawgit.com/feiss/aframe-environment-component/master/dist/aframe-environment-component.min.js"></script>
	<script src="//unpkg.com/xterm@3.12.0/dist/xterm.js"></script>
<script src="//unpkg.com/aframe-xterm-component@1.0.1/aframe-xterm-component.js"></script>
<script src="//unpkg.com/xterm-js-shell@1.1.3/bundle.js"></script>
<script src="https://ranger.mauve.moe/dat-xr-scene-ide//editor-terminal.js"></script>
	<script src="reaction_components/clickable.js"></script>
	<script src="reaction_components/draggable.js"></script>
	<script src="reaction_components/drag-droppable.js"></script>
	<script src="reaction_components/hoverable.js"></script>
	<script src="reaction_components/stretchable.js"></script>
	<script src="reaction_components/droppable.js"></script>
	<script src="reaction_components/grabbable.js"></script>

	<script src="components/aframe-ammo-constraints.js"></script>

    <script>
      AFRAME.registerComponent('createConstraint', {
        // ...
		// Target (other) body for the constraint.
    target: { type: "selector" },

    // Offset of the hinge or point-to-point constraint, defined locally in the body. Used for hinge, coneTwist pointToPoint constraints.
    pivot: { type: "vec3" },
    targetPivot: { type: "vec3" },

    // An axis that each body can rotate around, defined locally to that body. Used for hinge constraints.
    axis: { type: "vec3", default: { x: 0, y: 1, z: 0 } },
    targetAxis: { type: "vec3", default: { x: 0, y: 1, z: 0 } }
  },

  init: function() {
    this.system = this.el.sceneEl.systems.physics;
    this.constraint = null;
  },

  remove: function() {
    if (!this.constraint) return;

    this.system.removeConstraint(this.constraint);
    this.constraint = null;
  },

  update: function() {
    const el = this.el,
      data = this.data;

    this.remove();

    if (!el.body || !data.target.body) {
      (el.body ? data.target : el).addEventListener("body-loaded", this.update.bind(this, {}), { once: true });
      return;
    }

    this.constraint = this.createConstraint();
    this.system.addConstraint(this.constraint);
  },
/**
   * @return {Ammo.btTypedConstraint}
   */
  createConstraint, function() {
    let constraint;
    const data = this.data,
      body = this.el.body,
      targetBody = data.target.body;

    const bodyTransform = body
      .getCenterOfMassTransform()
      .inverse()
      .op_mul(targetBody.getWorldTransform());
    const targetTransform = new Ammo.btTransform();
    targetTransform.setIdentity();

    switch (data.type) {
      case CONSTRAINT.LOCK: {
        constraint = new Ammo.btGeneric6DofConstraint(body, targetBody, bodyTransform, targetTransform, true);
        const zero = new Ammo.btVector3(0, 0, 0);
        //TODO: allow these to be configurable
        constraint.setLinearLowerLimit(zero);
        constraint.setLinearUpperLimit(zero);
        constraint.setAngularLowerLimit(zero);
        constraint.setAngularUpperLimit(zero);
        Ammo.destroy(zero);
        break;
      }
      //TODO: test and verify all other constraint types
      case CONSTRAINT.FIXED: {
        //btFixedConstraint does not seem to debug render
        bodyTransform.setRotation(body.getWorldTransform().getRotation());
        targetTransform.setRotation(targetBody.getWorldTransform().getRotation());
        constraint = new Ammo.btFixedConstraint(body, targetBody, bodyTransform, targetTransform);
        break;
      }
      case CONSTRAINT.SPRING: {
        constraint = new Ammo.btGeneric6DofSpringConstraint(body, targetBody, bodyTransform, targetTransform, true);
        //TODO: enableSpring, setStiffness and setDamping
        break;
      }
      case CONSTRAINT.SLIDER: {
        //TODO: support setting linear and angular limits
        constraint = new Ammo.btSliderConstraint(body, targetBody, bodyTransform, targetTransform, true);
        constraint.setLowerLinLimit(-1);
        constraint.setUpperLinLimit(1);
        // constraint.setLowerAngLimit();
        // constraint.setUpperAngLimit();
        break;
      }
      case CONSTRAINT.HINGE: {
        const pivot = new Ammo.btVector3(data.pivot.x, data.pivot.y, data.pivot.z);
        const targetPivot = new Ammo.btVector3(data.targetPivot.x, data.targetPivot.y, data.targetPivot.z);

        const axis = new Ammo.btVector3(data.axis.x, data.axis.y, data.axis.z);
        const targetAxis = new Ammo.btVector3(data.targetAxis.x, data.targetAxis.y, data.targetAxis.z);

        constraint = new Ammo.btHingeConstraint(body, targetBody, pivot, targetPivot, axis, targetAxis, true);

        Ammo.destroy(pivot);
        Ammo.destroy(targetPivot);
        Ammo.destroy(axis);
        Ammo.destroy(targetAxis);
        break;
      }
      case CONSTRAINT.CONE_TWIST: {
        const pivotTransform = new Ammo.btTransform();
        pivotTransform.setIdentity();
        pivotTransform.getOrigin().setValue(data.targetPivot.x, data.targetPivot.y, data.targetPivot.z);
        constraint = new Ammo.btConeTwistConstraint(body, pivotTransform);
        Ammo.destroy(pivotTransform);
        break;
      }
      case CONSTRAINT.POINT_TO_POINT: {
        const pivot = new Ammo.btVector3(data.pivot.x, data.pivot.y, data.pivot.z);
        const targetPivot = new Ammo.btVector3(data.targetPivot.x, data.targetPivot.y, data.targetPivot.z);

        constraint = new Ammo.btPoint2PointConstraint(body, targetBody, pivot, targetPivot);

        Ammo.destroy(pivot);
        Ammo.destroy(targetPivot);
        break;
      }
      default:
        throw new Error("[constraint] Unexpected type: " + data.type);
    }

    Ammo.destroy(bodyTransform);
    Ammo.destroy(targetTransform);

    return constraint;
  }
  
});  
    </script>
    <link rel="stylesheet" type="text/css" href="aframe.css">
  </head>
  <body>
    <a-scene environment="preset: contact; dressingAmount: 0; ground: flat; lightPosition: 19 19 19; shadow: true" inspector="url: https://cdn.jsdelivr.net/gh/aframevr/aframe-inspector@master/dist/aframe-inspector.min.js">
	<a-assets>
	  	<a-asset-item id="g01" src="fxx_Reduced.glb"></a-asset-item>
        	<a-asset-item id="g02" src="fyy_Reduced.glb"></a-asset-item>
        	<a-asset-item id="g03" src="fzz_Reduced.glb"></a-asset-item>
		<a-asset-item id="g04" src="UJBlockRed.glb"></a-asset-item>
        	<a-asset-item id="g05" src="UJBlockBlue.glb"></a-asset-item>
        	<a-asset-item id="g06" src="UJBlockGreen.glb"></a-asset-item>
		<a-asset-item id="g07" src="fxx_Reduced.glb"></a-asset-item>
        	<a-asset-item id="g08" src="fyy_Reduced.glb"></a-asset-item>
        	<a-asset-item id="g09" src="fzz_Reduced.glb"></a-asset-item>
		
	  </a-assets>
	
	  <a-entity position="0 2 -3" >
	  	<a-entity gltf-model="#g01" static-body="shape: box; mass: 0" position="0 0 0" rotation="0 0 0" scale="1 1 1"></a-entity>
	    	<a-entity gltf-model="#g02" static-body="shape: box; mass: 0" position="0.1895 0 0" rotation="0 0 0" scale="1 1 1"></a-entity>
    		<a-entity gltf-model="#g03" static-body="shape: box; mass: 0" position="9
											0 180 0" rotation="0 0 0" scale="1 1 1"></a-entity>
	  </a-entity>
	    <a-entity position="-3 2 -3" >
	  	<a-entity gltf-model="#g01" static-body="shape: box; mass: 0" position="0 0 0" rotation="0 0 90" scale="1 1 1"></a-entity>
			<a-entity gltf-model="#g02" static-body="shape: box; mass: 0" position="0 0 0" rotation="0 0 90" scale="1 1 1"></a-entity>
			<a-entity gltf-model="#g03" static-body="shape: box; mass: 0" position="0 0 0" rotation="0 0 90" scale="1 1 1"></a-entity>
		</a-entity>
	    </a-entity>
    </a-scene>
  </body>
</html>
